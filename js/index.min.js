function getTodayStr(){return formatDate(new Date)}function formatDate(n){const t=n.getFullYear(),i=("00"+(n.getMonth()+1)).slice(-2),r=("00"+n.getDate()).slice(-2),u=["日","月","火","水","木","金","土"][n.getDay()];return`${t}/${i}/${r} (${u})`}function getDateFromChart(n){return lineChart[n]?lineChart[n].config.data.datasets[0].label:null}function getStrageKey(n){return n.substr(0,4)+$("#area option:selected").val()}function getCurrDateString(){return $("#date").val().replace(/\//g,"-").split(" ")[0]}function getData(){const n=getCurrDateString();if(!lineChart[swipe.getPos()]||n!=getDateFromChart(swipe.getPos())){const t=getStrageKey(n);if(sessionStorage.getItem(t)!=null){const i=JSON.parse(sessionStorage.getItem(t));drawChart(getDataToday(i,n),n);initDataTable()}else{const u=n.substr(0,4),r=$("#area option:selected").val(),f=r.substr(0,2),e=r.substr(2);var i=location.host?location.host:"churageographic.github.io";i=="churageographic.com"&&(i+="/tides");const o=`https://${i}/data/${f}/${e}/${u}.json`;$.get(o,function(i){if(i.warn||i.error){for(let n in i)i.warn?toastr.warning(i.warn):toastr.error(i.error);return}sessionStorage.setItem(t,JSON.stringify(i));drawChart(getDataToday(i,n),n);initDataTable()},"json").fail(function(){toastr.error(`「 ${$("#area option:selected").text()}の情報を取得できませんでした`);drawChartEmpty(n);initDataTable()})}}}function drawChartEmpty(n){drawChartEmptyWithSwipeIndex(n,swipe.getPos())}function getDayDiffABS(n,t){return Math.abs((n-t)/864e5)}function drawChartEmptyWithSwipeIndex(n,t){var i=new Date(getDateFromChart(swipe.getPos())),r=new Date(getDateFromChart(t));getDayDiffABS(i,r)<=1||drawChartWithSwipeIndex(EMPTY_CHART_DATA,n,t)}function getDataToday(n,t){for(var r=[],u=[],i=0;i<n.length;i++)t==n[i].d&&(r.push(n[i].t),u.push(n[i].l),n[i].t==23&&(r.push(24),u.push(n.length!=i+1?n[i+1].l:0)));return{time:r,level:u}}function getDataTodayJson(n,t){for(var r=[],i=0;i<n.length;i++)t==n[i].d&&(r.push(n[i]),n[i].t==23&&r.push(n.length!=i+1?n[i+1]:{d:"",t:0,l:"?"}));return r}function resetChart(){for(var n=0;lineChart.length>n;n++)drawChartWithSwipeIndex(EMPTY_CHART_DATA,null,n)}function resetPrevAndNextChart(){const t=swipe.getPos();for(var n=0;lineChart.length>n;n++)t!=n&&drawChartEmptyWithSwipeIndex(null,n)}function drawChart(n,t){drawChartWithSwipeIndex(n,t,swipe.getPos())}function drawChartWithSwipeIndex(n,t,i){lineChart[i]&&lineChart[i].destroy();const u=$("[id=chart]")[i].getContext("2d"),r=getPointSize(),f=getFontSizeScale();lineChart[i]=new Chart(u,{type:"line",data:{labels:n.time,datasets:[{label:t?t.replace(/-/g,"/"):null,data:n.level,backgroundColor:COLOR.OCEAN,fill:!0,borderColor:function(n){const i=n.chart,{ctx:r,chartArea:t}=i;return t?getGradient(r,t):null}}]},options:{animation:!1,responsive:!0,elements:{line:{tension:.35,borderWidth:r*.75},point:{pointStyle:"circle",radius:r*.75,borderWidth:r,hoverRadius:r*.75,hoverBorderWidth:r,hitRadius:r*3}},plugins:{title:{display:!1,text:"",font:{size:getFontSize()}},legend:{display:!1},tooltip:{titleFont:{size:f},bodyFont:{size:f*1.25},callbacks:{title:function(n){return`${n[0].dataset.label} ${n[0].parsed.x}:00`},label:function(n){return` ${n.parsed.y}cm`}}}},scales:{x:{ticks:{autoSkip:!1,maxRotation:0,minRotation:0,maxTicksLimit:getMaxTickLimit(),color:COLOR.WHITE,font:{size:getFontSizeScale()},callback:function(n,t){return t%getTickDivision()==0?n:""}},grid:{color:function(){return COLOR.LIGHTGRAY}}},y:{ticks:{stepSize:30,font:{size:getFontSizeScale()},color:COLOR.LIGHTGRAY},min:-30,max:240,grid:{color:function(n){return n.tick.value==0?COLOR.WHITE:COLOR.LIGHTGRAY}}}}},plugins:[DataLabelPluginPoint,VerticalLinePlugin,{beforeDraw:drawBackground(u)}]})}function getGradient(n,t){return gradient==null&&(width=t.right-t.left,height=t.bottom-t.top,gradient=n.createLinearGradient(0,t.bottom,0,t.top),gradient.addColorStop(1,COLOR.DEEPPINK),gradient.addColorStop(.75,COLOR.MIDNIGHTBLUE),gradient.addColorStop(.5,COLOR.BLUE),gradient.addColorStop(.25,COLOR.AQUAMARINE),gradient.addColorStop(0,COLOR.YELLOW)),gradient}function drawBackground(n){return function(t){var i=t.scales.x,r=t.scales.y,f=i.left,u=r.getPixelForValue(0),e=r.getPixelForValue(-30)-u;n.fillStyle=COLOR.REEF;n.fillRect(f,u,i.width,e)}}function getTickDivision(){return window.matchMedia(MIN_WIDTH.W1200).matches?1:window.matchMedia(MIN_WIDTH.W960).matches?2:window.matchMedia(MIN_WIDTH.W720).matches?2:window.matchMedia(MIN_WIDTH.W480).matches?3:3}function getMaxTickLimit(){return window.matchMedia(MIN_WIDTH.W1200).matches?25:window.matchMedia(MIN_WIDTH.W960).matches?13:window.matchMedia(MIN_WIDTH.W720).matches?13:window.matchMedia(MIN_WIDTH.W480).matches?9:9}function getPointSize(){return window.matchMedia(MIN_WIDTH.W1200).matches?5:window.matchMedia(MIN_WIDTH.W960).matches?5:window.matchMedia(MIN_WIDTH.W720).matches?4:window.matchMedia(MIN_WIDTH.W480).matches?3:2}function getPaddingDataLabel(){return window.matchMedia(MIN_WIDTH.W1200).matches?25:window.matchMedia(MIN_WIDTH.W960).matches?20:window.matchMedia(MIN_WIDTH.W720).matches?15:window.matchMedia(MIN_WIDTH.W480).matches?10:9}function getFontSize(){return window.matchMedia(MIN_WIDTH.W1200).matches?22.5:window.matchMedia(MIN_WIDTH.W960).matches?18.75:window.matchMedia(MIN_WIDTH.W720).matches?15:window.matchMedia(MIN_WIDTH.W480).matches?11.25:7.5}function getFontSizeScale(){return window.matchMedia(MIN_WIDTH.W1200).matches?20:window.matchMedia(MIN_WIDTH.W960).matches?19:window.matchMedia(MIN_WIDTH.W720).matches?16.5:window.matchMedia(MIN_WIDTH.W480).matches?15:13}function initToast(){toastr.options={positionClass:"toast-top-center",showDuration:"50",hideDuration:"100",timeOut:"1500"}}function initAreaList(){const t={"沖縄":[{text:"我喜屋",value:"4701"},{text:"渡久地",value:"4704"},{text:"東",value:"4733"},{text:"石川",value:"4707"},{text:"那覇",value:"4705"},{text:"仲里",value:"4726"},{text:"平良",value:"4713"},{text:"長山",value:"4714"},{text:"石垣",value:"4715"},{text:"船越",value:"4737"},{text:"白浜",value:"4720"},{text:"比川",value:"4717"}]};var n=$("#area"),i=[];Object.keys(t).forEach(function(n){var t=$("<optgroup>").prop("label",n);Object.keys(this[n]).forEach(function(n){t.append($("<option>").text(this[n].text).val(this[n].value).prop("selected",this[n].value==getDefaultArea()))},this[n]);i.push(t)},t);n.append(i);n.change(function(){resetChart();getData()});$(document).ready(function(){n.select2({width:"resolve"})});$(document).on("click",".ui-widget-overlay",function(){$(this).prev().find(".ui-dialog-content").dialog("close")})}function initClearStorageButton(){$("#clearStorage").click(function(){localStorage.clear();toastr.info("Cleared!")})}function getDefaultArea(){const n=qs("area");return String(n).match(/^\d{4}$/g)?n:"4705"}function getDefaultDate(){const n=qs("date");return String(n).match(/^\d{8}$/g)?`${n.substr(0,4)}-${n.substr(4,2)}-${n.substr(6,2)}`:getTodayStr()}function initDatePicker(){$("#date").datepicker({dateFormat:"yy/mm/dd (D)",showButtonPanel:!0,changeMonth:!0,changeYear:!0,minDate:new Date(2020,0,1),maxDate:new Date(2023,11,31)}).on("change",function(){const n=new Date(getDateFromChart(swipe.getPos())),t=new Date(this.value+" 09:00");if(formatDate(n)!=formatDate(t)){if(dateChangingByDateButton=!0,getDayDiffABS(n,t)>1)for(var i=0;lineChart.length>i;i++)drawChartWithSwipeIndex(EMPTY_CHART_DATA,null,i);n<t?swipe.next():swipe.prev()}}).val(getDefaultDate())}function initDateButton(n,t){$("#"+n).click(function(){updateDateText(t);dateChangingByDateButton=!0;t>0?swipe.next():swipe.prev()})}function updateDateText(n){const t=new Date($("#date").val());t.setDate(t.getDate()+n);const i=formatDate(t);$("#date").val(i)}function updateDateButtons(){const n=formatDate(new Date($("#date").val())),r=formatDate($("#date").datepicker("option","minDate")),u=formatDate($("#date").datepicker("option","maxDate")),t=r==n,i=u==n;$("#prevDate").prop("disabled",t);$("#nextDate").prop("disabled",i);$("#prevDate").css({color:t?"#d3d3d3":"#444"});$("#nextDate").css({color:i?"#d3d3d3":"#444"})}function initSwipe(){var n=document.getElementById("swipe");swipe=new Swipe(n,{startSlide:1,continuous:!0,disableScroll:!0,callback:function(n,t,i){if(dateChangingByDateButton){dateChangingByDateButton=!1;return}updateDateText(i==1?-1:1)},transitionEnd:function(){getData();updateDateButtons();resetPrevAndNextChart()}})}function getEmptyTableData(){return{destroy:!0,data:[{d:"",t:0,l:"?"}],paging:!1,searching:!1,info:!1,ordering:!1,columns:[{data:"d",render:function(){return""}},{data:"t",render:function(){return""}},{data:"l",render:function(){return""}}]}}function getDataTableData(n){var t=getDataTableFormatter((new Date).getHours());return{destroy:!0,data:n,paging:!1,searching:!1,info:!1,ordering:!1,columns:[{data:"d",render:function(n,i,r){return t(n.replace(/-/g,"/"),"",r)}},{data:"t",render:function(n,i,r){return t(n,":00",r)}},{data:"l",render:function(n,i,r){return t(n,"cm",r)}}]}}function getDataTableFormatter(n){return function(t,i,r){const u=t+i,f=getTodayStr().replace(/\//g,"-").split(" ")[0];return f==r.d&&r.t==n?`<span style='color:${COLOR.DEEPPINK};font-weight:bold;'>${u}</span>`:f==r.d&&Math.abs(r.t-n)==1?`<span style='color:${COLOR.MIDNIGHTBLUE};'>${u}</span>`:u}}function initDataTable(){const n=getCurrDateString();if(n!=getDateFromChart(swipe.getPos())){const t=getStrageKey(n);if(sessionStorage.getItem(t)==null){$("#dataTable").DataTable(getEmptyTableData());return}const i=JSON.parse(sessionStorage.getItem(t)),r=getDataTodayJson(i,n);$("#dataTable").DataTable(getDataTableData(r))}}function qs(n){n=n.replace(/[*+?^$.\[\]{}()|\\\/]/g,"\\$&");var t=location.search.match(new RegExp("[?&]"+n+"=([^&]+)(&|$)"));return t&&decodeURIComponent(t[1].replace(/\+/g," "))}var lineChart,DataLabelPluginPoint,VerticalLinePlugin,dateChangingByDateButton,swipe;const COLOR={WHITE:"#ffffff",GRAY:"#9e9e9e",DARKGRAY:"#1B2631",LIGHTGRAY:"#AEB6BF",BLUE:"#1e90ff",MIDNIGHTBLUE:"#0000cd",AQUAMARINE:"#7fffd4",DEEPPINK:"#ff1493",YELLOW:"#FFFF00",PURPLE:"#800080",OCEAN:"rgba(0, 0, 255, 0.2)",REEF:"rgba(21, 67, 96, 0.3)"};const EMPTY_CHART_DATA={time:[0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24],level:[]};lineChart=[];let width,height,gradient;DataLabelPluginPoint={afterDatasetsDraw:function(n){n.data.datasets.forEach(function(t){var i=n.ctx,t,r;i.save();t=n.data.datasets[0];r=n.getDatasetMeta(0);r.data.forEach(function(n,r){var e,o,u;if(r%getTickDivision()==0){i.fillStyle=COLOR.WHITE;var f=getFontSizeScale();i.font=Chart.helpers.fontString(f,"normal","Helvetica Neue");e=t.data[r].toString();i.textAlign="center";i.textBaseline="middle";o=getPaddingDataLabel();u=n.tooltipPosition();i.fillText(e,u.x,u.y-f/2-o)}});i.restore()})}};VerticalLinePlugin={afterDatasetDraw:function(n,t){if(t.meta.data.length!=0){const r=new Date,u=r.getHours(),f=r.getMinutes(),e=t.meta.data[0].x,o=t.meta.data[1].x,s=(o-e)/60*f;var h=n.data.datasets[0],i=n.ctx;i.save();t.meta.data.forEach(function(t,r){if(r==u&&h.label==getTodayStr().split(" ")[0]){i.strokeStyle=COLOR.DEEPPINK;i.lineWidth=t.options.borderWidth/1.5;i.beginPath();const f=t.x+s;i.moveTo(f,n.chartArea.top);i.lineTo(f,n.chartArea.bottom);i.stroke()}});i.restore()}}};const MIN_WIDTH={W1200:"(min-width: 1200px)",W960:"(min-width: 960px)",W720:"(min-width: 720px)",W480:"(min-width: 480px)"};dateChangingByDateButton=!1;swipe=null;$(function(){initToast();initAreaList();initDatePicker();initDateButton("prevDate",-1);initDateButton("nextDate",1);initClearStorageButton();initSwipe();getData()});$(document).ajaxSend(function(){$.LoadingOverlay("show",{image:"",maxSize:50,fontawesome:"fa fa-spinner fa-pulse",fontawesomeAnimation:"rotate_right",fontawesomeColor:COLOR.GRAY})});$(document).ajaxComplete(function(){$.LoadingOverlay("hide")})