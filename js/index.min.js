const COLOR={WHITE:"#ffffff",GRAY:"#9e9e9e",DARKGRAY:"#1B2631",LIGHTGRAY:"#AEB6BF",BLUE:"#1e90ff",MIDNIGHTBLUE:"#0000cd",AQUAMARINE:"#7fffd4",DEEPPINK:"#ff1493",YELLOW:"#FFFF00",PURPLE:"#800080",OCEAN:"rgba(0, 0, 255, 0.2)",REEF:"rgba(21, 67, 96, 0.3)"};function getTodayStr(){return formatDate(new Date)}function formatDate(t){return`${t.getFullYear()}/${("00"+(t.getMonth()+1)).slice(-2)}/${("00"+t.getDate()).slice(-2)} (${["日","月","火","水","木","金","土"][t.getDay()]})`}function getDateFromChart(t){return lineChart[t]?lineChart[t].config.data.datasets[0].label:null}function getStrageKey(t){return t.substr(0,4)+$("#area option:selected").val()}function getCurrDateString(){return $("#date").val().replace(/\//g,"-").split(" ")[0]}function getData(){const t=getCurrDateString();if(lineChart[swipe.getPos()]&&t==getDateFromChart(swipe.getPos()))return;const e=getStrageKey(t);if(null!=sessionStorage.getItem(e)){drawChart(getDataToday(JSON.parse(sessionStorage.getItem(e)),t),t),initDataTable()}else{const n=t.substr(0,4),i=$("#area option:selected").val(),o=i.substr(0,2),r=i.substr(2);var a=location.host?location.host:"churageographic.github.io";"churageographic.com"==a&&(a+="/tides");const c=`https://${a}/data/${o}/${r}/${n}.json`;$.get(c,function(a){if(a.warn||a.error)for(let t in a)a.warn?toastr.warning(a.warn):toastr.error(a.error);else sessionStorage.setItem(e,JSON.stringify(a)),drawChart(getDataToday(a,t),t),initDataTable()},"json").fail(function(e){toastr.error(`「 ${$("#area option:selected").text()}の情報を取得できませんでした`),drawChartEmpty(t),initDataTable()})}}function drawChartEmpty(t){drawChartEmptyWithSwipeIndex(t,swipe.getPos())}function getDayDiffABS(t,e){return Math.abs((t-e)/864e5)}const EMPTY_CHART_DATA={time:[0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24],level:[]};function drawChartEmptyWithSwipeIndex(t,e){getDayDiffABS(new Date(getDateFromChart(swipe.getPos())),new Date(getDateFromChart(e)))<=1||drawChartWithSwipeIndex(EMPTY_CHART_DATA,t,e)}function getDataToday(t,e){for(var a=[],n=[],i=0;i<t.length;i++)e==t[i].d&&(a.push(t[i].t),n.push(t[i].l),23==t[i].t&&(a.push(24),n.push(t.length!=i+1?t[i+1].l:0)));return{time:a,level:n}}function getDataTodayJson(t,e){for(var a=[],n=0;n<t.length;n++)e==t[n].d&&(a.push(t[n]),23==t[n].t&&a.push(t.length!=n+1?t[n+1]:{d:"",t:0,l:"?"}));return a}var lineChart=[];function resetChart(){for(var t=0;lineChart.length>t;t++)drawChartWithSwipeIndex(EMPTY_CHART_DATA,null,t)}function resetPrevAndNextChart(){const t=swipe.getPos();for(var e=0;lineChart.length>e;e++)t!=e&&drawChartEmptyWithSwipeIndex(null,e)}function drawChart(t,e){drawChartWithSwipeIndex(t,e,swipe.getPos())}function drawChartWithSwipeIndex(t,e,a){lineChart[a]&&lineChart[a].destroy();const n=$("[id=chart]")[a].getContext("2d"),i=getPointSize(),o=getFontSizeScale();lineChart[a]=new Chart(n,{type:"line",data:{labels:t.time,datasets:[{label:e?e.replace(/-/g,"/"):null,data:t.level,backgroundColor:COLOR.OCEAN,fill:!0,borderColor:function(t){const e=t.chart,{ctx:a,chartArea:n}=e;return n?getGradient(a,n):null}}]},options:{animation:!1,responsive:!0,elements:{line:{tension:.35,borderWidth:.75*i},point:{pointStyle:"circle",radius:.75*i,borderWidth:i,hoverRadius:.75*i,hoverBorderWidth:i,hitRadius:3*i}},plugins:{title:{display:!1,text:"",font:{size:getFontSize()}},legend:{display:!1},tooltip:{titleFont:{size:o},bodyFont:{size:1.25*o},callbacks:{title:function(t){return`${t[0].dataset.label} ${t[0].parsed.x}:00`},label:function(t){return` ${t.parsed.y}cm`}}}},scales:{x:{ticks:{autoSkip:!1,maxRotation:0,minRotation:0,maxTicksLimit:getMaxTickLimit(),color:COLOR.WHITE,font:{size:getFontSizeScale()},callback:function(t,e){return e%getTickDivision()==0?t:""}},grid:{color:function(t){return COLOR.LIGHTGRAY}}},y:{ticks:{stepSize:30,font:{size:getFontSizeScale()},color:COLOR.LIGHTGRAY},min:-30,max:240,grid:{color:function(t){return 0==t.tick.value?COLOR.WHITE:COLOR.LIGHTGRAY}}}}},plugins:[DataLabelPluginPoint,VerticalLinePlugin,{beforeDraw:drawBackground(n)}]})}let width,height,gradient;function getGradient(t,e){return null==gradient&&(width=e.right-e.left,height=e.bottom-e.top,(gradient=t.createLinearGradient(0,e.bottom,0,e.top)).addColorStop(1,COLOR.DEEPPINK),gradient.addColorStop(.75,COLOR.MIDNIGHTBLUE),gradient.addColorStop(.5,COLOR.BLUE),gradient.addColorStop(.25,COLOR.AQUAMARINE),gradient.addColorStop(0,COLOR.YELLOW)),gradient}var DataLabelPluginPoint={afterDatasetsDraw:function(t,e){t.data.datasets.forEach(function(e,a){var n=t.ctx;n.save();e=t.data.datasets[0];t.getDatasetMeta(0).data.forEach(function(t,a){if(a%getTickDivision()==0){n.fillStyle=COLOR.WHITE;var i=getFontSizeScale();n.font=Chart.helpers.fontString(i,"normal","Helvetica Neue");var o=e.data[a].toString();n.textAlign="center",n.textBaseline="middle";var r=getPaddingDataLabel(),c=t.tooltipPosition();n.fillText(o,c.x,c.y-i/2-r)}}),n.restore()})}},VerticalLinePlugin={afterDatasetDraw:function(t,e){if(0==e.meta.data.length)return;const a=new Date,n=a.getHours(),i=a.getMinutes(),o=e.meta.data[0].x,r=(e.meta.data[1].x-o)/60*i;var c=t.data.datasets[0],s=t.ctx;s.save(),e.meta.data.forEach(function(e,a){if(a!=n||c.label!=getTodayStr().split(" ")[0])return;s.strokeStyle=COLOR.DEEPPINK,s.lineWidth=e.options.borderWidth/1.5,s.beginPath();const i=e.x+r;s.moveTo(i,t.chartArea.top),s.lineTo(i,t.chartArea.bottom),s.stroke()}),s.restore()}};function drawBackground(t){return function(e,a){var n=e.scales.x,i=e.scales.y,o=n.left,r=i.getPixelForValue(0),c=i.getPixelForValue(-30)-r;t.fillStyle=COLOR.REEF,t.fillRect(o,r,n.width,c)}}const MIN_WIDTH={W1200:"(min-width: 1200px)",W960:"(min-width: 960px)",W720:"(min-width: 720px)",W480:"(min-width: 480px)"};function getTickDivision(){return window.matchMedia(MIN_WIDTH.W1200).matches?1:window.matchMedia(MIN_WIDTH.W960).matches?2:window.matchMedia(MIN_WIDTH.W720).matches?2:(window.matchMedia(MIN_WIDTH.W480).matches,3)}function getMaxTickLimit(){return window.matchMedia(MIN_WIDTH.W1200).matches?25:window.matchMedia(MIN_WIDTH.W960).matches?13:window.matchMedia(MIN_WIDTH.W720).matches?13:(window.matchMedia(MIN_WIDTH.W480).matches,9)}function getPointSize(){return window.matchMedia(MIN_WIDTH.W1200).matches?5:window.matchMedia(MIN_WIDTH.W960).matches?5:window.matchMedia(MIN_WIDTH.W720).matches?4:window.matchMedia(MIN_WIDTH.W480).matches?3:2}function getPaddingDataLabel(){return window.matchMedia(MIN_WIDTH.W1200).matches?25:window.matchMedia(MIN_WIDTH.W960).matches?20:window.matchMedia(MIN_WIDTH.W720).matches?15:window.matchMedia(MIN_WIDTH.W480).matches?10:9}function getFontSize(){return window.matchMedia(MIN_WIDTH.W1200).matches?22.5:window.matchMedia(MIN_WIDTH.W960).matches?18.75:window.matchMedia(MIN_WIDTH.W720).matches?15:window.matchMedia(MIN_WIDTH.W480).matches?11.25:7.5}function getFontSizeScale(){return window.matchMedia(MIN_WIDTH.W1200).matches?20:window.matchMedia(MIN_WIDTH.W960).matches?19:window.matchMedia(MIN_WIDTH.W720).matches?16.5:window.matchMedia(MIN_WIDTH.W480).matches?15:13}function initToast(){toastr.options={positionClass:"toast-top-center",showDuration:"50",hideDuration:"100",timeOut:"1500"}}function initAreaList(){const t={"沖縄":[{text:"我喜屋",value:"4701"},{text:"渡久地",value:"4704"},{text:"東",value:"4733"},{text:"石川",value:"4707"},{text:"那覇",value:"4705"},{text:"仲里",value:"4726"},{text:"平良",value:"4713"},{text:"長山",value:"4714"},{text:"石垣",value:"4715"},{text:"船越",value:"4737"},{text:"白浜",value:"4720"},{text:"比川",value:"4717"}]};var e=$("#area"),a=new Array;Object.keys(t).forEach(function(t,e){var n=$("<optgroup>").prop("label",t);Object.keys(this[t]).forEach(function(t,e){n.append($("<option>").text(this[t].text).val(this[t].value).prop("selected",this[t].value==getDefaultArea()))},this[t]),a.push(n)},t),e.append(a),e.change(function(){resetChart(),getData()}),$(document).ready(function(){e.select2({width:"resolve"})}),$(document).on("click",".ui-widget-overlay",function(){$(this).prev().find(".ui-dialog-content").dialog("close")})}function initClearStorageButton(){$("#clearStorage").click(function(){localStorage.clear(),toastr.info("Cleared!")})}function getDefaultArea(){const t=qs("area");return String(t).match(/^\d{4}$/g)?t:"4705"}function getDefaultDate(){const t=qs("date");return String(t).match(/^\d{8}$/g)?`${t.substr(0,4)}-${t.substr(4,2)}-${t.substr(6,2)}`:getTodayStr()}function initDatePicker(){$("#date").datepicker({dateFormat:"yy/mm/dd (D)",showButtonPanel:!0,changeMonth:!0,changeYear:!0,minDate:new Date(2020,0,1),maxDate:new Date(2023,11,31)}).on("change",function(){const t=new Date(getDateFromChart(swipe.getPos())),e=new Date(this.value+" 09:00");if(formatDate(t)!=formatDate(e)){if(dateChangingByDateButton=!0,getDayDiffABS(t,e)>1)for(var a=0;lineChart.length>a;a++)drawChartWithSwipeIndex(EMPTY_CHART_DATA,null,a);t<e?swipe.next():swipe.prev()}}).val(getDefaultDate())}var dateChangingByDateButton=!1;function initDateButton(t,e){$("#"+t).click(function(){updateDateText(e),dateChangingByDateButton=!0,e>0?swipe.next():swipe.prev()})}function updateDateText(t){const e=new Date($("#date").val());e.setDate(e.getDate()+t);const a=formatDate(e);$("#date").val(a)}function updateDateButtons(){const t=formatDate(new Date($("#date").val())),e=formatDate($("#date").datepicker("option","minDate"))==t,a=formatDate($("#date").datepicker("option","maxDate"))==t;$("#prevDate").prop("disabled",e),$("#nextDate").prop("disabled",a),$("#prevDate").css({color:e?"#d3d3d3":"#444"}),$("#nextDate").css({color:a?"#d3d3d3":"#444"})}var swipe=null;function initSwipe(){var t=document.getElementById("swipe");swipe=new Swipe(t,{startSlide:1,continuous:!0,disableScroll:!0,callback:function(t,e,a){dateChangingByDateButton?dateChangingByDateButton=!1:updateDateText(1==a?-1:1)},transitionEnd:function(t,e){getData(),updateDateButtons(),resetPrevAndNextChart()}})}function getEmptyTableData(){return{destroy:!0,data:[{d:"",t:0,l:"?"}],paging:!1,searching:!1,info:!1,ordering:!1,columns:[{data:"d",render:function(t,e,a){return""}},{data:"t",render:function(t,e,a){return""}},{data:"l",render:function(t,e,a){return""}}]}}function getDataTableData(t){var e=getDataTableFormatter((new Date).getHours());return{destroy:!0,data:t,paging:!1,searching:!1,info:!1,ordering:!1,scrollY:"30vh",scrollCollapse:!0,scroller:!0,columns:[{data:"d",render:function(t,a,n){return e(t.replace(/-/g,"/"),"",n)}},{data:"t",render:function(t,a,n){return e(t,":00",n)}},{data:"l",render:function(t,a,n){return e(t,"cm",n)}}],initComplete:function(){var t=$("#dataTable").DataTable().row((new Date).getHours()).node().getBoundingClientRect(),e=$("thead")[1].getBoundingClientRect();$(".dataTables_scrollBody").scrollTop(t.top+e.top)}}}function getDataTableFormatter(t){return function(e,a,n){const i=e+a,o=getTodayStr().replace(/\//g,"-").split(" ")[0];return o==n.d&&n.t==t?`<span style='color:${COLOR.DEEPPINK};font-weight:bold; animation: flash 2s linear infinite;'>${i}</span>`:o==n.d&&1==Math.abs(n.t-t)?`<span style='color:${COLOR.MIDNIGHTBLUE};'>${i}</span>`:i}}function initDataTable(){const t=getCurrDateString();if(t==getDateFromChart(swipe.getPos()))return;const e=getStrageKey(t);if(null==sessionStorage.getItem(e))return void $("#dataTable").DataTable(getEmptyTableData());const a=getDataTodayJson(JSON.parse(sessionStorage.getItem(e)),t);$("#dataTable").DataTable(getDataTableData(a))}function qs(t){t=t.replace(/[*+?^$.\[\]{}()|\\\/]/g,"\\$&");var e=location.search.match(new RegExp("[?&]"+t+"=([^&]+)(&|$)"));return e&&decodeURIComponent(e[1].replace(/\+/g," "))}$(function(){initToast(),initAreaList(),initDatePicker(),initDateButton("prevDate",-1),initDateButton("nextDate",1),initClearStorageButton(),initSwipe(),getData()}),$(document).ajaxSend(function(){$.LoadingOverlay("show",{image:"",maxSize:50,fontawesome:"fa fa-spinner fa-pulse",fontawesomeAnimation:"rotate_right",fontawesomeColor:COLOR.GRAY})}),$(document).ajaxComplete(function(){$.LoadingOverlay("hide")});