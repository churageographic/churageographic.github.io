'use strict';const COLOR={WHITE:"#ffffff",GRAY:"#9e9e9e",DARKGRAY:"#1B2631",LIGHTGRAY:"#AEB6BF",BLUE:"#1e90ff",MIDNIGHTBLUE:"#0000cd",AQUAMARINE:"#7fffd4",DEEPPINK:"#ff1493",YELLOW:"#FFFF00",PURPLE:"#800080",OCEAN:"rgba(0, 0, 255, 0.2)",REEF:"rgba(21, 67, 96, 0.3)"};function getTodayStr(){return formatDate(new Date)}
function formatDate(a){const b=a.getFullYear(),c=("00"+(a.getMonth()+1)).slice(-2),d=("00"+a.getDate()).slice(-2);a="\u65e5\u6708\u706b\u6c34\u6728\u91d1\u571f".split("")[a.getDay()];return`${b}/${c}/${d} (${a})`}function getDateFromChart(a){return lineChart[a]?lineChart[a].config.data.datasets[0].label:null}function getStrageKey(a){return a.substr(0,4)+$("#area option:selected").val()}function getCurrDateString(){return $("#date").val().replace(/\//g,"-").split(" ")[0]}
function getData(){const a=getCurrDateString();if(!lineChart[swipe.getPos()]||a!=getDateFromChart(swipe.getPos())){var b=getStrageKey(a);if(null!=sessionStorage.getItem(b)){var c=JSON.parse(sessionStorage.getItem(b));drawChart(getDataToday(c,a),a);initDataTable()}else{c=a.substr(0,4);var d=$("#area option:selected").val();const f=d.substr(0,2),g=d.substr(2);d=location.host?location.host:"churageographic.github.io";"churageographic.com"==d&&(d+="/tides");$.get(`https://${d}/data/${f}/${g}/${c}.json`,
function(e){if(e.warn||e.error)for(let h in e)e.warn?toastr.warning(e.warn):toastr.error(e.error);else sessionStorage.setItem(b,JSON.stringify(e)),drawChart(getDataToday(e,a),a),initDataTable()},"json").fail(function(e){toastr.error(`\u300c ${$("#area option:selected").text()}\u306e\u60c5\u5831\u3092\u53d6\u5f97\u3067\u304d\u307e\u305b\u3093\u3067\u3057\u305f`);drawChartEmpty(a);initDataTable()})}}}function drawChartEmpty(a){drawChartEmptyWithSwipeIndex(a,swipe.getPos())}
function getDayDiffABS(a,b){return Math.abs((a-b)/864E5)}const EMPTY_CHART_DATA={time:[0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24],level:[]};function drawChartEmptyWithSwipeIndex(a,b){var c=new Date(getDateFromChart(swipe.getPos())),d=new Date(getDateFromChart(b));1>=getDayDiffABS(c,d)||drawChartWithSwipeIndex(EMPTY_CHART_DATA,a,b)}
function getDataToday(a,b){for(var c=[],d=[],f=0;f<a.length;f++)b==a[f].d&&(c.push(a[f].t),d.push(a[f].l),23==a[f].t&&(c.push(24),d.push(a.length!=f+1?a[f+1].l:0)));return{time:c,level:d}}function getDataTodayJson(a,b){for(var c=[],d=0;d<a.length;d++)b==a[d].d&&(c.push(a[d]),23==a[d].t&&c.push(a.length!=d+1?a[d+1]:{d:"",t:0,l:"?"}));return c}var lineChart=[];function resetChart(){for(var a=0;lineChart.length>a;a++)drawChartWithSwipeIndex(EMPTY_CHART_DATA,null,a)}
function resetPrevAndNextChart(){const a=swipe.getPos();for(var b=0;lineChart.length>b;b++)a!=b&&drawChartEmptyWithSwipeIndex(null,b)}function drawChart(a,b){drawChartWithSwipeIndex(a,b,swipe.getPos())}
function drawChartWithSwipeIndex(a,b,c){lineChart[c]&&lineChart[c].destroy();const d=$("[id=chart]")[c].getContext("2d"),f=getPointSize(),g=getFontSizeScale();lineChart[c]=new Chart(d,{type:"line",data:{labels:a.time,datasets:[{label:b?b.replace(/-/g,"/"):null,data:a.level,backgroundColor:COLOR.OCEAN,fill:!0,borderColor:function(e){const {ctx:h,chartArea:k}=e.chart;return k?getGradient(h,k):null}}]},options:{animation:!1,responsive:!0,elements:{line:{tension:.35,borderWidth:.75*f},point:{pointStyle:"circle",
radius:.75*f,borderWidth:f,hoverRadius:.75*f,hoverBorderWidth:f,hitRadius:3*f}},plugins:{title:{display:!1,text:"",font:{size:getFontSize()}},legend:{display:!1},tooltip:{titleFont:{size:g},bodyFont:{size:1.25*g},callbacks:{title:function(e){return`${e[0].dataset.label} ${e[0].parsed.x}:00`},label:function(e){return` ${e.parsed.y}cm`}}}},scales:{x:{ticks:{autoSkip:!1,maxRotation:0,minRotation:0,maxTicksLimit:getMaxTickLimit(),color:COLOR.WHITE,font:{size:getFontSizeScale()},callback:function(e,h){return 0==
h%getTickDivision()?e:""}},grid:{color:function(e){return COLOR.LIGHTGRAY}}},y:{ticks:{stepSize:30,font:{size:getFontSizeScale()},color:COLOR.LIGHTGRAY},min:-30,max:240,grid:{color:function(e){return 0==e.tick.value?COLOR.WHITE:COLOR.LIGHTGRAY}}}}},plugins:[DataLabelPluginPoint,VerticalLinePlugin,{beforeDraw:drawBackground(d)}]})}let width,height,gradient;
function getGradient(a,b){null==gradient&&(width=b.right-b.left,height=b.bottom-b.top,gradient=a.createLinearGradient(0,b.bottom,0,b.top),gradient.addColorStop(1,COLOR.DEEPPINK),gradient.addColorStop(.75,COLOR.MIDNIGHTBLUE),gradient.addColorStop(.5,COLOR.BLUE),gradient.addColorStop(.25,COLOR.AQUAMARINE),gradient.addColorStop(0,COLOR.YELLOW));return gradient}
var DataLabelPluginPoint={afterDatasetsDraw:function(a,b){a.data.datasets.forEach(function(c,d){var f=a.ctx;f.save();c=a.data.datasets[0];a.getDatasetMeta(0).data.forEach(function(g,e){if(0==e%getTickDivision()){f.fillStyle=COLOR.WHITE;var h=getFontSizeScale();f.font=Chart.helpers.fontString(h,"normal","Helvetica Neue");e=c.data[e].toString();f.textAlign="center";f.textBaseline="middle";var k=getPaddingDataLabel();g=g.tooltipPosition();f.fillText(e,g.x,g.y-h/2-k)}});f.restore()})}},VerticalLinePlugin=
{afterDatasetDraw:function(a,b){if(0!=b.meta.data.length){var c=new Date,d=c.getHours();c=c.getMinutes();var f=(b.meta.data[1].x-b.meta.data[0].x)/60*c,g=a.data.datasets[0],e=a.ctx;e.save();b.meta.data.forEach(function(h,k){k==d&&g.label==getTodayStr().split(" ")[0]&&(e.strokeStyle=COLOR.DEEPPINK,e.lineWidth=h.options.borderWidth/1.5,e.beginPath(),h=h.x+f,e.moveTo(h,a.chartArea.top),e.lineTo(h,a.chartArea.bottom),e.stroke())});e.restore()}}};
function drawBackground(a){return function(b,c){c=b.scales.x;var d=b.scales.y;b=c.left;var f=d.getPixelForValue(0);d=d.getPixelForValue(-30)-f;a.fillStyle=COLOR.REEF;a.fillRect(b,f,c.width,d)}}const MIN_WIDTH={W1200:"(min-width: 1200px)",W960:"(min-width: 960px)",W720:"(min-width: 720px)",W480:"(min-width: 480px)"};
function getTickDivision(){if(window.matchMedia(MIN_WIDTH.W1200).matches)return 1;if(window.matchMedia(MIN_WIDTH.W960).matches||window.matchMedia(MIN_WIDTH.W720).matches)return 2;window.matchMedia(MIN_WIDTH.W480);return 3}function getMaxTickLimit(){if(window.matchMedia(MIN_WIDTH.W1200).matches)return 25;if(window.matchMedia(MIN_WIDTH.W960).matches||window.matchMedia(MIN_WIDTH.W720).matches)return 13;window.matchMedia(MIN_WIDTH.W480);return 9}
function getPointSize(){return window.matchMedia(MIN_WIDTH.W1200).matches?5:window.matchMedia(MIN_WIDTH.W960).matches?5:window.matchMedia(MIN_WIDTH.W720).matches?4:window.matchMedia(MIN_WIDTH.W480).matches?3:2}function getPaddingDataLabel(){return window.matchMedia(MIN_WIDTH.W1200).matches?25:window.matchMedia(MIN_WIDTH.W960).matches?20:window.matchMedia(MIN_WIDTH.W720).matches?15:window.matchMedia(MIN_WIDTH.W480).matches?10:9}
function getFontSize(){return window.matchMedia(MIN_WIDTH.W1200).matches?22.5:window.matchMedia(MIN_WIDTH.W960).matches?18.75:window.matchMedia(MIN_WIDTH.W720).matches?15:window.matchMedia(MIN_WIDTH.W480).matches?11.25:7.5}function getFontSizeScale(){return window.matchMedia(MIN_WIDTH.W1200).matches?20:window.matchMedia(MIN_WIDTH.W960).matches?19:window.matchMedia(MIN_WIDTH.W720).matches?16.5:window.matchMedia(MIN_WIDTH.W480).matches?15:13}
function initToast(){toastr.options={positionClass:"toast-top-center",showDuration:"50",hideDuration:"100",timeOut:"1500"}}
function initAreaList(){const a={"\u6c96\u7e04":[{text:"\u6211\u559c\u5c4b",value:"4701"},{text:"\u6e21\u4e45\u5730",value:"4704"},{text:"\u6771",value:"4733"},{text:"\u77f3\u5ddd",value:"4707"},{text:"\u90a3\u8987",value:"4705"},{text:"\u4ef2\u91cc",value:"4726"},{text:"\u5e73\u826f",value:"4713"},{text:"\u9577\u5c71",value:"4714"},{text:"\u77f3\u57a3",value:"4715"},{text:"\u8239\u8d8a",value:"4737"},{text:"\u767d\u6d5c",value:"4720"},{text:"\u6bd4\u5ddd",value:"4717"}]};var b=$("#area"),c=[];Object.keys(a).forEach(function(d,
f){var g=$("<optgroup>").prop("label",d);Object.keys(this[d]).forEach(function(e,h){g.append($("<option>").text(this[e].text).val(this[e].value).prop("selected",this[e].value==getDefaultArea()))},this[d]);c.push(g)},a);b.append(c);b.change(function(){resetChart();getData()});$(document).ready(function(){b.select2({width:"resolve"})});$(document).on("click",".ui-widget-overlay",function(){$(this).prev().find(".ui-dialog-content").dialog("close")})}
function initClearStorageButton(){$("#clearStorage").click(function(){localStorage.clear();toastr.info("Cleared!")})}function getDefaultArea(){const a=qs("area");return String(a).match(/^\d{4}$/g)?a:"4705"}function getDefaultDate(){const a=qs("date");return String(a).match(/^\d{8}$/g)?`${a.substr(0,4)}-${a.substr(4,2)}-${a.substr(6,2)}`:getTodayStr()}
function initDatePicker(){$("#date").datepicker({dateFormat:"yy/mm/dd (D)",showButtonPanel:!0,changeMonth:!0,changeYear:!0,minDate:new Date(2020,0,1),maxDate:new Date(2026,11,31)}).on("change",function(){const a=new Date(getDateFromChart(swipe.getPos())),b=new Date(this.value+" 09:00");if(formatDate(a)!=formatDate(b)){dateChangingByDateButton=!0;if(1<getDayDiffABS(a,b))for(var c=0;lineChart.length>c;c++)drawChartWithSwipeIndex(EMPTY_CHART_DATA,null,c);a<b?swipe.next():swipe.prev()}}).val(getDefaultDate())}
var dateChangingByDateButton=!1;function initDateButton(a,b){$("#"+a).click(function(){updateDateText(b);dateChangingByDateButton=!0;0<b?swipe.next():swipe.prev()})}function updateDateText(a){const b=new Date($("#date").val());b.setDate(b.getDate()+a);a=formatDate(b);$("#date").val(a)}
function updateDateButtons(){var a=formatDate(new Date($("#date").val())),b=formatDate($("#date").datepicker("option","minDate"));const c=formatDate($("#date").datepicker("option","maxDate"));b=b==a;a=c==a;$("#prevDate").prop("disabled",b);$("#nextDate").prop("disabled",a);$("#prevDate").css({color:b?"#d3d3d3":"#444"});$("#nextDate").css({color:a?"#d3d3d3":"#444"})}var swipe=null;
function initSwipe(){var a=document.getElementById("swipe");swipe=new Swipe(a,{startSlide:1,continuous:!0,disableScroll:!0,callback:function(b,c,d){dateChangingByDateButton?dateChangingByDateButton=!1:updateDateText(1==d?-1:1)},transitionEnd:function(b,c){getData();updateDateButtons();resetPrevAndNextChart()}})}
function getEmptyTableData(){return{destroy:!0,data:[{d:"",t:0,l:"?"}],paging:!1,searching:!1,info:!1,ordering:!1,columns:[{data:"d",render:function(a,b,c){return""}},{data:"t",render:function(a,b,c){return""}},{data:"l",render:function(a,b,c){return""}}]}}
function getDataTableData(a){var b=getDataTableFormatter((new Date).getHours());return{destroy:!0,data:a,paging:!1,searching:!1,info:!1,ordering:!1,scrollY:"34.3vh",scrollCollapse:!0,scroller:!0,columns:[{data:"d",render:function(c,d,f){return b(c.replace(/-/g,"/"),"",f)}},{data:"t",render:function(c,d,f){return b(c,":00",f)}},{data:"l",render:function(c,d,f){return b(c,"cm",f)}}],initComplete:function(){var c=$("#dataTable").DataTable().row((new Date).getHours()).node().getBoundingClientRect().height*
(new Date).getHours();$(".dataTables_scrollBody").scrollTop(c)}}}function getDataTableFormatter(a){return function(b,c,d){b+=c;c=getTodayStr().replace(/\//g,"-").split(" ")[0];return c==d.d&&d.t==a?`<span style='color:${COLOR.DEEPPINK};font-weight:bold; animation: flash 2s linear infinite;'>${b}</span>`:c==d.d&&1==Math.abs(d.t-a)?`<span style='color:${COLOR.MIDNIGHTBLUE};'>${b}</span>`:b}}
function initDataTable(){var a=getCurrDateString();if(a!=getDateFromChart(swipe.getPos())){var b=getStrageKey(a);null==sessionStorage.getItem(b)?$("#dataTable").DataTable(getEmptyTableData()):(b=JSON.parse(sessionStorage.getItem(b)),a=getDataTodayJson(b,a),$("#dataTable").DataTable(getDataTableData(a)))}}function qs(a){a=a.replace(/[*+?^$.\[\]{}()|\\\/]/g,"\\$&");return(a=location.search.match(new RegExp("[?&]"+a+"=([^&]+)(&|$)")))&&decodeURIComponent(a[1].replace(/\+/g," "))}
$(function(){initToast();initAreaList();initDatePicker();initDateButton("prevDate",-1);initDateButton("nextDate",1);initClearStorageButton();initSwipe();getData()});$(document).ajaxSend(function(){$.LoadingOverlay("show",{image:"",maxSize:50,fontawesome:"fa fa-spinner fa-pulse",fontawesomeAnimation:"rotate_right",fontawesomeColor:COLOR.GRAY})});$(document).ajaxComplete(function(){$.LoadingOverlay("hide")});